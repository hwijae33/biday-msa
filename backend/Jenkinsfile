pipeline {
    agent any

    parameters {
        string(name: 'MODULE', defaultValue: 'all', description: 'Specify module to build (or all)')
    }

    environment {
        JAVA_HOME = '/opt/java/openjdk' // JDK path
        GRADLE_HOME = '/opt/gradle' // Replace with the correct Gradle path
        PATH = "${GRADLE_HOME}/bin:${env.PATH}" // Add Gradle to PATH
        DOCKER_HUB_REPO = "hwijae/biday" // Docker Hub repository
    }

    stages {
        stage('Build') {
            steps {
                script {
                    sh '''
                        #!/bin/bash
                        set -e
                        export JAVA_HOME="$JAVA_HOME"

                        # Change to the backend directory
                        cd backend || { echo "Backend directory not found!"; exit 1; }

                        echo "Current directory contents:"
                        ls -la  # List the contents of the backend directory

                        # Check if gradlew exists and make it executable
                        if [ -f "./gradlew" ]; then
                            echo "Found gradlew. Making it executable..."
                            chmod +x ./gradlew
                        else
                            echo "gradlew not found!"
                            exit 1
                        fi

                        all_modules="server:eureka-server server:config-server server:gateway-server service:admin-service service:auction-service service:ftp-service service:order-service service:product-service service:sms-service service:user-service"

                        echo "Cleaning..."
                        ./gradlew clean

                        for module in $all_modules; do
                            echo "Building BootJar for $module"
                            ./gradlew :$module:bootJar || { echo "Failed to build $module"; exit 1; }
                        done
                    '''
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: '**/build/libs/*.jar', allowEmptyArchive: true
                }
                failure {
                    echo "Build stage failed!"
                    error 'Build failed'
                }
            }
        }


        stage('Docker Login') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'DockerHub_IdPw', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                        sh "echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin"
                    }
                }
            }
        }

        stage('Docker build') {
            steps {
                script {
                    sh 'docker-compose build || { echo "Docker build failed!"; exit 1; }'
                }
            }
        }

        stage('Docker Push') {
            steps {
                script {
                    def services = [
                        "product-service",
                        "order-service",
                        "gateway-server",
                        "ftp-service",
                        "auction-service",
                        "user-service",
                        "admin-service",
                        "sms-service",
                        "eureka-server"
                    ]

                    for (service in services) {
                        echo "Tagging and pushing ${service}..."
                        sh "docker tag biday/${service}:latest ${DOCKER_HUB_REPO}:${service} || { echo 'Docker tag failed for ${service}!'; exit 1; }"
                        sh "docker push ${DOCKER_HUB_REPO}:${service} || { echo 'Docker push failed for ${service}!'; exit 1; }"
                    }
                }
            }
            post {
                failure {
                    echo "Docker push failed!"
                    error 'Docker push failed'
                }
            }
        }
    }

    post {
        always {
            echo 'Cleaning up...'
        }
        success {
            notifySlack("Build succeeded!", "good")
            notifyDiscord("Build succeeded!", "success")
        }
        failure {
            notifySlack("Build failed!", "danger")
            notifyDiscord("Build failed!", "failure")
        }
    }
}

// Functions to send notifications
def notifySlack(String message, String color) {
    withCredentials([string(credentialsId: 'Slack_webhook', variable: 'SLACK_WEBHOOK')]) {
        def slackPayload = [
            text: message,
            attachments: [
                [
                    title: "${env.JOB_NAME} : ${currentBuild.displayName} ${message.contains("failed") ? "실패" : "성공"}",
                    text: """
                    제목 : ${currentBuild.displayName}
                    결과 : ${currentBuild.result}
                    실행 시간 : ${currentBuild.duration / 1000}s
                    """,
                    color: color
                ]
            ]
        ]
        sh "curl -X POST -H 'Content-Type: application/json' -d '${groovy.json.JsonOutput.toJson(slackPayload)}' ${SLACK_WEBHOOK}"
    }
}

def notifyDiscord(String message, String result) {
    withCredentials([string(credentialsId: 'Discord-Webhook', variable: 'DISCORD')]) {
        discordSend description: """
        제목 : ${currentBuild.displayName}
        결과 : ${currentBuild.result}
        실행 시간 : ${currentBuild.duration / 1000}s
        """,
        link: env.BUILD_URL, result: result,
        title: "${env.JOB_NAME} : ${currentBuild.displayName} ${message.contains("failed") ? "실패" : "성공"}",
        webhookURL: "$DISCORD"
    }
}
